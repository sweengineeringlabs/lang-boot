apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: rustboot-app
  labels:
    app: rustboot-app
    environment: production
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: rustboot-app
  endpoints:
  - port: metrics
    path: /metrics
    interval: 30s
    scrapeTimeout: 10s
    scheme: http
    # Add relabeling if needed
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      targetLabel: node
    - sourceLabels: [__meta_kubernetes_namespace]
      targetLabel: namespace
  namespaceSelector:
    matchNames:
    - production
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: rustboot-app-alerts
  labels:
    app: rustboot-app
    environment: production
    prometheus: kube-prometheus
spec:
  groups:
  - name: rustboot-app
    interval: 30s
    rules:
    # High error rate alert
    - alert: HighErrorRate
      expr: |
        sum(rate(http_requests_total{app="rustboot-app",status=~"5.."}[5m]))
        /
        sum(rate(http_requests_total{app="rustboot-app"}[5m]))
        > 0.05
      for: 5m
      labels:
        severity: critical
        component: rustboot-app
      annotations:
        summary: "High error rate detected"
        description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

    # High response time alert
    - alert: HighResponseTime
      expr: |
        histogram_quantile(0.95,
          sum(rate(http_request_duration_seconds_bucket{app="rustboot-app"}[5m]))
          by (le)
        ) > 1
      for: 5m
      labels:
        severity: warning
        component: rustboot-app
      annotations:
        summary: "High response time detected"
        description: "95th percentile response time is {{ $value }}s (threshold: 1s)"

    # Pod not ready alert
    - alert: PodNotReady
      expr: |
        kube_pod_status_ready{condition="false",namespace="production",pod=~".*rustboot-app.*"}
        == 1
      for: 5m
      labels:
        severity: warning
        component: rustboot-app
      annotations:
        summary: "Pod is not ready"
        description: "Pod {{ $labels.pod }} is not ready for more than 5 minutes"

    # High CPU usage alert
    - alert: HighCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="production",pod=~".*rustboot-app.*"}[5m]))
        by (pod)
        > 0.8
      for: 10m
      labels:
        severity: warning
        component: rustboot-app
      annotations:
        summary: "High CPU usage detected"
        description: "CPU usage for {{ $labels.pod }} is {{ $value | humanizePercentage }}"

    # High memory usage alert
    - alert: HighMemoryUsage
      expr: |
        sum(container_memory_working_set_bytes{namespace="production",pod=~".*rustboot-app.*"})
        by (pod)
        /
        sum(container_spec_memory_limit_bytes{namespace="production",pod=~".*rustboot-app.*"})
        by (pod)
        > 0.9
      for: 10m
      labels:
        severity: warning
        component: rustboot-app
      annotations:
        summary: "High memory usage detected"
        description: "Memory usage for {{ $labels.pod }} is {{ $value | humanizePercentage }}"

    # Pod restart alert
    - alert: PodRestarting
      expr: |
        rate(kube_pod_container_status_restarts_total{namespace="production",pod=~".*rustboot-app.*"}[15m])
        > 0
      for: 5m
      labels:
        severity: warning
        component: rustboot-app
      annotations:
        summary: "Pod is restarting"
        description: "Pod {{ $labels.pod }} is restarting frequently"

    # Deployment replica mismatch alert
    - alert: DeploymentReplicasMismatch
      expr: |
        kube_deployment_spec_replicas{namespace="production",deployment=~".*rustboot-app.*"}
        !=
        kube_deployment_status_replicas_available{namespace="production",deployment=~".*rustboot-app.*"}
      for: 10m
      labels:
        severity: warning
        component: rustboot-app
      annotations:
        summary: "Deployment replicas mismatch"
        description: "Deployment {{ $labels.deployment }} has mismatched replicas"
