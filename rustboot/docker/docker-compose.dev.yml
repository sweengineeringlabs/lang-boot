# Docker Compose configuration for development
# Use: docker compose -f docker/docker-compose.dev.yml up

version: '3.9'

services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.builder
      args:
        BINARY_NAME: rustboot-app
      target: builder  # Stop at builder stage for development
    container_name: rustboot-app-dev
    ports:
      - "8080:8080"
      - "9000:9000"  # Debug port
    environment:
      APP_NAME: rustboot-app-dev
      APP_ENV: development
      APP_HOST: 0.0.0.0
      APP_PORT: 8080

      DATABASE_URL: postgres://rustboot:rustboot_password@postgres:5432/rustboot_db
      REDIS_URL: redis://redis:6379

      # Development settings
      RUST_LOG: debug,rustboot=trace
      LOG_FORMAT: pretty
      DEV_MODE: true
      HOT_RELOAD: false

      # Relaxed security for development
      SESSION_COOKIE_SECURE: false
      CORS_ALLOWED_ORIGINS: "*"
    volumes:
      # Mount source code for development (enable for hot reload)
      - ../:/build
      # Cache cargo dependencies
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/build/target
    command: cargo run --bin rustboot-app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - rustboot-network
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    container_name: rustboot-postgres-dev
    environment:
      POSTGRES_USER: rustboot
      POSTGRES_PASSWORD: rustboot_password
      POSTGRES_DB: rustboot_db
    ports:
      - "5432:5432"
    volumes:
      - postgres-data-dev:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - rustboot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rustboot"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: rustboot-redis-dev
    command: redis-server --appendonly no --save ""
    ports:
      - "6379:6379"
    networks:
      - rustboot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: rustboot-pgadmin-dev
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@rustboot.dev
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin-data-dev:/var/lib/pgadmin
    networks:
      - rustboot-network
    restart: unless-stopped
    depends_on:
      - postgres

  # Redis Commander
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: rustboot-redis-commander-dev
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "8081:8081"
    networks:
      - rustboot-network
    restart: unless-stopped
    depends_on:
      - redis

networks:
  rustboot-network:
    driver: bridge

volumes:
  postgres-data-dev:
    driver: local
  pgadmin-data-dev:
    driver: local
  cargo-cache:
    driver: local
  target-cache:
    driver: local
